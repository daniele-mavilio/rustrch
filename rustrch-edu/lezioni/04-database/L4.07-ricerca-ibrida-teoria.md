## Teoria

La ricerca ibrida rappresenta un approccio avanzato che combina i vantaggi della ricerca basata su parole chiave (come BM25) con quelli della ricerca semantica basata su embedding. Questo metodo è particolarmente utile nei motori di ricerca moderni, dove la precisione e la rilevanza dei risultati sono fondamentali. 

La ricerca ibrida funziona integrando due tipi di punteggi: uno basato sulla corrispondenza lessicale (BM25) e uno basato sulla similarità semantica (embedding). Il punteggio finale di un documento è una combinazione pesata di questi due punteggi. Questo permette di superare i limiti di entrambi i metodi: BM25 è eccellente nel trovare documenti che contengono esattamente le parole chiave della query, ma può fallire nel comprendere il significato sottostante. D'altra parte, la ricerca semantica è brava a catturare il significato della query, ma può essere meno precisa nel trovare corrispondenze esatte.

Un aspetto cruciale della ricerca ibrida è la gestione dei pesi. I pesi determinano quanto ciascun metodo contribuisce al punteggio finale. Ad esempio, se si assegna un peso maggiore a BM25, il sistema darà più importanza alle corrispondenze esatte delle parole chiave. Viceversa, se si assegna un peso maggiore agli embedding, il sistema sarà più orientato verso la comprensione semantica della query. La scelta dei pesi dipende dal contesto e dagli obiettivi specifici del motore di ricerca.

## Esempio

Immaginiamo di avere un motore di ricerca per un sito di e-commerce. Un utente cerca "scarpe da corsa leggere". Utilizzando solo BM25, il sistema potrebbe restituire risultati che contengono esattamente le parole "scarpe", "corsa" e "leggere", ma potrebbe non catturare prodotti che sono semanticamente simili ma non contengono tutte le parole chiave. Ad esempio, potrebbe perdere "scarpe running ultraleggere".

D'altra parte, utilizzando solo la ricerca semantica, il sistema potrebbe catturare il significato di "scarpe da corsa leggere" e restituire risultati che includono "scarpe running ultraleggere", ma potrebbe anche includere risultati meno rilevanti che non contengono nessuna delle parole chiave.

Con la ricerca ibrida, il sistema può combinare i punteggi di BM25 e degli embedding per ottenere il meglio da entrambi i mondi. Ad esempio, potrebbe assegnare un peso del 60% a BM25 e un peso del 40% agli embedding. In questo modo, il sistema darà priorità ai documenti che contengono le parole chiave esatte, ma terrà anche conto della similarità semantica per catturare risultati che potrebbero essere rilevanti ma non contengono tutte le parole chiave.

## Pseudocodice

```rust
// Definizione della struttura per i risultati della ricerca ibrida
struct HybridSearchResult {
    document_id: u32,
    bm25_score: f32,
    embedding_score: f32,
    combined_score: f32,
}

// Funzione per calcolare il punteggio combinato
fn calculate_combined_score(bm25_score: f32, embedding_score: f32, bm25_weight: f32, embedding_weight: f32) -> f32 {
    // Normalizza i punteggi per assicurarsi che siano tra 0 e 1
    let normalized_bm25 = normalize_score(bm25_score);
    let normalized_embedding = normalize_score(embedding_score);
    
    // Calcola il punteggio combinato
    let combined_score = (normalized_bm25 * bm25_weight) + (normalized_embedding * embedding_weight);
    combined_score
}

// Funzione per normalizzare i punteggi
fn normalize_score(score: f32) -> f32 {
    // Implementazione della normalizzazione
    // Ad esempio, si potrebbe usare una funzione di normalizzazione min-max
    score / (score + 1.0)
}

// Funzione principale per la ricerca ibrida
fn hybrid_search(query: &str, documents: &[Document], bm25_weight: f32, embedding_weight: f32) -> Vec<HybridSearchResult> {
    let mut results = Vec::new();
    
    for doc in documents {
        // Calcola il punteggio BM25 per il documento
        let bm25_score = calculate_bm25_score(query, doc);
        
        // Calcola il punteggio di embedding per il documento
        let embedding_score = calculate_embedding_score(query, doc);
        
        // Calcola il punteggio combinato
        let combined_score = calculate_combined_score(bm25_score, embedding_score, bm25_weight, embedding_weight);
        
        // Aggiungi il risultato alla lista
        results.push(HybridSearchResult {
            document_id: doc.id,
            bm25_score,
            embedding_score,
            combined_score,
        });
    }
    
    // Ordina i risultati per punteggio combinato
    results.sort_by(|a, b| b.combined_score.partial_cmp(&a.combined_score).unwrap());
    results
}
```

## Risorse

- [Rust Book: Traits](https://doc.rust-lang.org/book/ch10-02-traits.html)
- [Rust by Example: Traits](https://doc.rust-lang.org/rust-by-example/trait.html)
- [Rust Standard Library: f32](https://doc.rust-lang.org/std/primitive.f32.html)

## Esercizio

Immagina di dover implementare un sistema di ricerca ibrida per un motore di ricerca che deve gestire query in lingua naturale. Quali pesi assegneresti a BM25 e agli embedding per massimizzare la rilevanza dei risultati? Spiega la tua scelta e fornisci un esempio di query e risultati attesi.